<!DOCTYPE html>
<meta charset=utf-8>
<title>Subresource Integrity</title>
<script src="/resources/testharness.js"></script>
<script src="/resources/testharnessreport.js"></script>
<script src="/resources/sriharness.js"></script>

<div id="log"></div>

<div id="container"></div>
<script>
    // This horrible hack is needed for the 'use-credentials' tests because, on
    // response, if port 80 or 443 is the current port, it will not appear to
    // the browser as part of the origin string. Since the origin *string* is
    // used for CORS access control, instead of the origin itself, if there
    // isn't an exact string match, the check will fail. For example,
    // "http://example.com" would not match "http://example.com:80", because
    // they are not exact string matches, even though the origins are the same.
    //
    // Thus, we only want the Access-Control-Allow-Origin header to have
    // the port if it's not port 80 or 443, since the user agent will elide the
    // ports in those cases.
    var main_domain = "{{domains[]}}";
    var www_domain = "{{domains[www]}}";
    var default_port = "{{ports[http][0]}}";
    if (location.protocol === "https:") {
      default_port = "{{ports[https][0]}}";
    }

    var port_string = "";
    if (default_port !== "80" && default_port !== "443")
      port_string = ":" + default_port;

    www_host_and_port = www_domain + port_string;

    var same_origin_prefix = '/subresource-integrity/';

    // Cross-origin prefix for all destinations.
    var xorigin_prefix = location.protocol
      + '//' + www_host_and_port
      + '/subresource-integrity/';

    let i = 0;
    // Preload tests
    new SRIPreloadTest(
        true,                                                               /* preload_sri_success */
        true,                                                               /* subresource_sri_success */
        "Same-origin with correct sha256 hash.",                            /* name */
        "script",                                                           /* destination */
        `${same_origin_prefix}script.py?${i++}`,                            /* resource_url */
        {integrity: "sha256-8aBiAJl3ukQwSJ6eTs5wl6hGjnOtyXjcTRdAf89uIfY="}, /* link_attrs */
        {}                                                                  /* subresource_attrs */
    ).execute();

    new SRIPreloadTest(
        true,
        true,
        "Same-origin with correct sha384 hash.",
        "script",
        `${same_origin_prefix}script.py?${i++}`,
        {integrity: "sha384-s8f5al9VgSm3a8aDojjk23fyOBzqlU00xES/M5yLeg0TWOQ6jlMcXMWBDmtJbsaF"},
        {}
    ).execute();

    new SRIPreloadTest(
        true,
        true,
        "Same-origin with correct sha512 hash.",
        "script",
        `${same_origin_prefix}script.py?${i++}`,
        {integrity: "sha512-onMedz6dwXySavy4mWnUQqii6xGUqDea6EVhQJJinoyQ/6E3dgX52DEQE1ZCvmzNH4rCcMxCzLs/uVxKkoG2DA=="},
        {}
    ).execute();

    new SRIPreloadTest(
        true,
        true,
        "Same-origin with empty integrity.",
        "script",
        `${same_origin_prefix}script.py?${i++}`,
        {},
        {}
    ).execute();

    new SRIPreloadTest(
        false,
        false,
        "Same-origin with incorrect hash.",
        "script",
        `${same_origin_prefix}script.py?${i++}`,
        {integrity: "sha256-deadbeefdeadbeefdeadbeefdeadbeefdeadbeefdead"},
        {}
    ).execute();

    new SRIPreloadTest(
        true,
        true,
        "Same-origin with multiple sha256 hashes, including correct.",
        "script",
        `${same_origin_prefix}script.py?${i++}`,
        {integrity: "sha256-8aBiAJl3ukQwSJ6eTs5wl6hGjnOtyXjcTRdAf89uIfY= sha256-deadbeefdeadbeefdeadbeefdeadbeefdeadbeefdead"},
        {}
    ).execute();

    new SRIPreloadTest(
        true,
        true,
        "Same-origin with multiple sha256 hashes, including unknown algorithm.",
        "script",
        `${same_origin_prefix}script.py?${i++}`,
        {integrity: "sha256-8aBiAJl3ukQwSJ6eTs5wl6hGjnOtyXjcTRdAf89uIfY= foo666-deadbeefdeadbeefdeadbeefdeadbeefdeadbeefdead"},
        {}
    ).execute();

    new SRIPreloadTest(
        true,
        true,
        "Same-origin with sha256 mismatch, sha512 match",
        "script",
        `${same_origin_prefix}script.py?${i++}`,
        {integrity: "sha512-onMedz6dwXySavy4mWnUQqii6xGUqDea6EVhQJJinoyQ/6E3dgX52DEQE1ZCvmzNH4rCcMxCzLs/uVxKkoG2DA== sha256-deadbeefdeadbeefdeadbeefdeadbeefdeadbeefdead"},
        {}
    ).execute();

    new SRIPreloadTest(
        false,
        false,
        "Same-origin with sha256 match, sha512 mismatch",
        "script",
        `/subresource-integrity/matching-digest.js?${i++}`,
        {integrity: "sha512-deadbeefspbnUnwooKGNNCb39nvg+EW0O9hDScTXeo/9pVZztLSUYU3LNV6H0lZapo8bCJUpyPPLAzE9fDzpxg== sha256-8aBiAJl3ukQwSJ6eTs5wl6hGjnOtyXjcTRdAf89uIfY="},
        {}
    ).execute();

    new SRIPreloadTest(
        true,
        true,
        "<crossorigin='anonymous'> with correct hash, ACAO: *",
        "script",
        `${xorigin_prefix}script.py?${i++}&anonymous`,
        {integrity: "sha256-8aBiAJl3ukQwSJ6eTs5wl6hGjnOtyXjcTRdAf89uIfY=", crossOrigin: 'anonymous'},
        {crossOrigin: "anonymous"}
    ).execute();

    new SRIPreloadTest(
        false,
        false,
        "<crossorigin='anonymous'> with incorrect hash, ACAO: *",
        "script",
        `${xorigin_prefix}script.py?${i++}&anonymous`,
        {integrity: "sha256-sha256-deadbeefdeadbeefdeadbeefdeadbeefdeadbeefdead", crossOrigin: "anonymous"},
        {crossOrigin: "anonymous"}
    ).execute();

    new SRIPreloadTest(
        true,
        true,
        "<crossorigin='use-credentials'> with correct hash, CORS-eligible",
        "script",
        `${xorigin_prefix}script.py?${i++}&with_credentials`,
        {integrity: "sha256-8aBiAJl3ukQwSJ6eTs5wl6hGjnOtyXjcTRdAf89uIfY=", crossOrigin: "use-credentials"},
        {crossOrigin: "use-credentials"}
    ).execute();

    // Hereeeeee.
    new SRIPreloadTest(
        false,
        false,
        "<crossorigin='use-credentials'> with incorrect hash CORS-eligible",
        "script",
        `${xorigin_prefix}script.py?${i++}&with_credentials`,
        {integrity: "sha256-deadbeef2S+pTRZgiw3DWrhC6JLDlt2zRyGpwH7unU8=", crossOrigin: "use-credentials"},
        {crossOrigin: "use-credentials"}
    ).execute();

    new SRIPreloadTest(
        false,
        false,
        "<crossorigin='anonymous'> with CORS-ineligible resource",
        "script",
        `${xorigin_prefix}script.py?${i++}`, /* no &anonymous makes this CORS-ineligible */
        {integrity: "sha256-F5fXKTX7SiWjtgybxiBZIo2qhh2WiQnNx372E60XrOo=", crossOrigin: "anonymous"},
        {crossOrigin: "anonymous"}
    ).execute();

    new SRIPreloadTest(
        false,
        false,
        "Cross-origin, not CORS request, with correct hash",
        "script",
        `${xorigin_prefix}script.py?${i++}&anonymous`,
        {integrity: "sha256-51AjITq701Y0yKSx3/UoIKtIY2UQ9+H8WGyyMuOWOC0="},
        {}
    ).execute();

    new SRIPreloadTest(
        false,
        false,
        "Cross-origin, not CORS request, with hash mismatch",
        "script",
        `${xorigin_prefix}script.py?${i++}&anonymous`,
        {integrity: "sha256-deadbeef01Y0yKSx3/UoIKtIY2UQ9+H8WGyyMuOWOC0="},
        {}
    ).execute();

    new SRIPreloadTest(
        true,
        true,
        "Cross-origin, empty integrity",
        "script",
        `${xorigin_prefix}script.py?${i++}&anonymous`,
        {},
        {}
    ).execute();

    new SRIPreloadTest(
        true,
        true,
        "Same-origin with correct hash, options.",
        "script",
        `${same_origin_prefix}script.py?${i++}`,
        {integrity: "sha256-8aBiAJl3ukQwSJ6eTs5wl6hGjnOtyXjcTRdAf89uIfY=?foo=bar?spam=eggs"},
        {}
    ).execute();

    new SRIPreloadTest(
        true,
        true,
        "Same-origin with unknown algorithm only.",
        "script",
        `${same_origin_prefix}script.py?${i++}`,
        {integrity: "foo666-8aBiAJl3ukQwSJ6eTs5wl6hGjnOtyXjcTRdAf89uIfY="},
        {}
    ).execute();
</script>
